#!/bin/sh

# A general, all-purpose extraction script.
# Default behavior: Extract archive into new directory
# Behavior with `-c` option: Extract contents into current directory

while getopts "hc" o; do
    case "${o}" in
        c) extracthere="True" ;;
        *) printf "Options:\n   -c: Extract archive into current directory rather than a new one.\n" && exit 1 ;;
    esac
done
shift $((OPTIND - 1))

archive="$(readlink -f "$1")"

[ -z "$archive" ] && printf "Give archive to extract as argument.\n" && exit 1
[ ! -f "$archive" ] && printf "File \"%s\" not found.\n" "$archive" && exit 1

# Determine if this is a single-file compression format
case "$archive" in
    *.bz2|*.gz|*.xz|*.lzma)
        singlefile="True"
        ;;
    *)
        singlefile=""
        ;;
esac

# Create directory unless:
# - -c was given
# - OR it's a single-file compression
if [ -z "$extracthere" ] && [ -z "$singlefile" ]; then
    directory="$(basename "$archive")"
    directory="${directory%.*}"
    mkdir -p "$directory" || exit 1
    cd "$directory" || exit 1
fi

# Extract
case "$archive" in
    *.tar.bz2|*.tbz2) tar xvjf "$archive" ;;
    *.tar.xz) tar -xf "$archive" ;;
    *.tar.gz|*.tgz) tar xvzf "$archive" ;;
    *.tar.zst) tar -I zstd -xf "$archive" ;;
    *.tar) tar xvf "$archive" ;;
    *.zip) unzip "$archive" ;;
    *.rar) unrar x -ad "$archive" ;;
    *.7z) 7z x "$archive" ;;
    *.Z) uncompress "$archive" ;;
    *.exe) cabextract "$archive" ;;
    *.bz2) bunzip2 "$archive" ;;
    *.gz) gunzip "$archive" ;;
    *.xz) unxz "$archive" ;;
    *.lzma) unlzma "$archive" ;;
    *)
        printf "extract: '%s' - unknown archive method\n" "$archive"
        exit 1
        ;;
esac

